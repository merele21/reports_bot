# ‚ö†Ô∏è –í–ê–ñ–ù–û: –ü–æ—Ä—è–¥–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ Aiogram 3

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞

–í Aiogram 3 middleware –ø–µ—Ä–µ–¥–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ handlers —á–µ—Ä–µ–∑ **keyword arguments**, –ù–û –ø–æ—Ä—è–¥–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ —Å–∏–≥–Ω–∞—Ç—É—Ä–µ —Ñ—É–Ω–∫—Ü–∏–∏ **–∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ** –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö.

## ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### –î–ª—è Message handlers:
```python
async def handler(
    message: Message,      # 1. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π (event)
    state: FSMContext,     # 2. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π (FSM)
    session: AsyncSession  # 3. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π (Database)
):
    pass
```

### –î–ª—è CallbackQuery handlers:
```python
async def handler(
    callback: CallbackQuery,  # 1. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π (event)
    state: FSMContext,        # 2. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π (FSM)
    session: AsyncSession     # 3. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π (Database)
):
    pass
```

## ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (–í–´–ó–´–í–ê–ï–¢ –û–®–ò–ë–ö–ò)

```python
# –û–®–ò–ë–ö–ê 1: session –ø–µ—Ä–µ–¥ state
async def handler(
    callback: CallbackQuery,
    session: AsyncSession,  # ‚ùå –ù–µ —Ç–∞–∫!
    state: FSMContext
):
    pass

# –û–®–ò–ë–ö–ê 2: session –ø–µ—Ä–µ–¥ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
async def handler(
    session: AsyncSession,  # ‚ùå –ù–µ —Ç–∞–∫!
    callback: CallbackQuery,
    state: FSMContext
):
    pass
```

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ commands_fsm.py

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

1. **process_register_no_store** (—Å—Ç—Ä–æ–∫–∞ ~172)
   ```python
   # –ë–´–õ–û:
   async def process_register_no_store(
       callback: CallbackQuery,
       session: AsyncSession,  # ‚ùå
       state: FSMContext
   ):

   # –°–¢–ê–õ–û:
   async def process_register_no_store(
       callback: CallbackQuery,
       state: FSMContext,      # ‚úÖ
       session: AsyncSession
   ):
   ```

2. **process_register_with_store** (—Å—Ç—Ä–æ–∫–∞ ~212)
   ```python
   # –ë–´–õ–û:
   async def process_register_with_store(
       callback: CallbackQuery,
       state: FSMContext,
       session: AsyncSession  # –≠—Ç–æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
   ):

   # –°–¢–ê–õ–û:
   async def process_register_with_store(
       callback: CallbackQuery,
       state: FSMContext
       # session —É–±—Ä–∞–Ω, —Ç.–∫. –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
   ):
   ```

3. **process_cancel_callback** (—Å—Ç—Ä–æ–∫–∞ ~1377)
   ```python
   # –ë–´–õ–û:
   async def process_cancel_callback(
       callback: CallbackQuery,
       state: FSMContext,
       session: AsyncSession  # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
   ):

   # –°–¢–ê–õ–û:
   async def process_cancel_callback(
       callback: CallbackQuery,
       state: FSMContext
       # session —É–±—Ä–∞–Ω
   ):
   ```

## üìã –ü—Ä–∞–≤–∏–ª–æ –±–æ–ª—å—à–æ–≥–æ –ø–∞–ª—å—Ü–∞

**–ü–æ—Ä—è–¥–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:**
1. Event (Message / CallbackQuery) ‚Äî **–í–°–ï–ì–î–ê –ü–ï–†–í–´–ô**
2. FSMContext (state) ‚Äî –µ—Å–ª–∏ –Ω—É–∂–µ–Ω
3. AsyncSession (session) ‚Äî –µ—Å–ª–∏ –Ω—É–∂–µ–Ω
4. –î—Ä—É–≥–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ‚Äî –≤ –∫–æ–Ω—Ü–µ

**–£–¥–∞–ª—è–π –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- –ï—Å–ª–∏ `session` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ ‚Üí —É–±–µ—Ä–∏ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –ï—Å–ª–∏ `state` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚Üí —É–±–µ—Ä–∏ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –≠—Ç–æ **–Ω–µ** —ç–∫–æ–Ω–æ–º–∏—è, —ç—Ç–æ **–∏–∑–±–µ–∂–∞–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤** –ø—Ä–∏ DI

## üéØ –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ

Aiogram –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **dependency injection** —á–µ—Ä–µ–∑ middleware. –ï—Å–ª–∏ –ø–æ—Ä—è–¥–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏:

1. **TypeError** ‚Äî –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π positional argument
2. **Missing argument** ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω
3. **Wrong type** ‚Äî –ø–µ—Ä–µ–¥–∞–Ω –æ–±—ä–µ–∫—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ç–∏–ø–∞

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø—Ä–æ–≤–µ—Ä—å:

```python
# –í—Å–µ CallbackQuery handlers:
@router.callback_query(...)
async def handler(callback: CallbackQuery, state: FSMContext, session: AsyncSession):
    #                 ^^^^^^^^^^^^^^^^        ^^^^^^^^^^^^^    ^^^^^^^^^^^^^^^^
    #                 1. Event                2. FSM           3. Database
    pass

# –í—Å–µ Message handlers:
@router.message(...)
async def handler(message: Message, state: FSMContext, session: AsyncSession):
    #             ^^^^^^^^^^^^^^^    ^^^^^^^^^^^^^    ^^^^^^^^^^^^^^^^
    #             1. Event           2. FSM           3. Database
    pass
```

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤—Å–µ callback-–∫–Ω–æ–ø–∫–∏ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫ `missing required positional argument`.