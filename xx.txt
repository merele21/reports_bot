import logging
import io
from datetime import time, datetime
from typing import Dict

from aiogram import Router, F
from aiogram.filters import Command, CommandObject
from aiogram.types import Message
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

from bot.config import settings
from bot.database.crud import UserCRUD, ChannelCRUD, UserChannelCRUD, PhotoTemplateCRUD
from bot.database.models import User

router = Router()
logger = logging.getLogger(__name__)

# --- FSM States ---
class PhotoTemplateStates(StatesGroup):
    waiting_for_photos = State()
    waiting_for_description = State()

class EventStates(StatesGroup):
    waiting_for_event_data = State()

# –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
template_data: Dict[int, dict] = {}

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
def is_admin(user_id: int) -> bool:
    return user_id in settings.admin_list

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ ---

@router.message(Command("start"))
async def cmd_start(message: Message, session: AsyncSession):
    telegram_id = message.from_user.id
    existing_user = await UserCRUD.get_by_telegram_id(session, telegram_id)
    
    user = await UserCRUD.get_or_create(
        session,
        telegram_id=telegram_id,
        username=message.from_user.username or "",
        full_name=message.from_user.full_name,
    )
    
    if message.chat.type == "private":
        if existing_user:
            await message.answer(
                f"<b>–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã, {user.full_name}!</b>\n"
                f"–í–∞—à ID: <code>{user.telegram_id}</code>"
            )
        else:
            await message.answer(
                f"<b>–ü—Ä–∏–≤–µ—Ç, {user.full_name}!</b>\n\n"
                f"–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.\n"
                f"–¢–µ–ø–µ—Ä—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –≥—Ä—É–ø–ø—ã –ø–æ —Ç–µ–≥—É @{user.username}."
            )

@router.message(Command("help"))
async def cmd_help(message: Message):
    user_id = message.from_user.id
    help_text = "<b>–ö–æ–º–∞–Ω–¥—ã:</b>\n\n"
    help_text += "‚Ä¢ /start - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è\n"
    help_text += "‚Ä¢ /get_user_id - –£–∑–Ω–∞—Ç—å ID (—Å–≤–æ–π/reply/username)\n"
    
    if is_admin(user_id):
        help_text += "\n<b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ:</b>\n"
        help_text += "‚Ä¢ /add_ch - –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª/—Ç—Ä–µ–¥\n"
        help_text += "‚Ä¢ /add_event - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç—á–µ—Ç (–¥–µ–¥–ª–∞–π–Ω, –∫–ª—é—á)\n"
        help_text += "‚Ä¢ /add_user - –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞\n"
        help_text += "‚Ä¢ /add_users - –ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ\n"
        help_text += "‚Ä¢ /rm_user - –£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞\n"
        help_text += "‚Ä¢ /rm_users - –ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ\n"
        help_text += "‚Ä¢ /add_template - –î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω —Ñ–æ—Ç–æ\n"
        help_text += "‚Ä¢ /list_channels - –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤\n"

    await message.answer(help_text)

# --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ ---

@router.message(Command("add_user"))
async def cmd_add_user(message: Message, command: CommandObject, session: AsyncSession):
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –ê—Ä–≥—É–º–µ–Ω—Ç—ã -> Reply"""
    if not is_admin(message.from_user.id): return

    thread_id = message.message_thread_id if message.is_topic_message else None
    channel = await ChannelCRUD.get_by_chat_and_thread(session, message.chat.id, thread_id)
    if not channel:
        await message.answer("–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /add_ch")
        return

    target_user = None
    args = command.args

    # 1. –ü–†–ò–û–†–ò–¢–ï–¢: –ê–†–ì–£–ú–ï–ù–¢–´
    if args:
        val = args.replace("@", "").strip()
        if not val:
            await message.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username.")
            return

        if val.isdigit():
            target_user = await UserCRUD.get_by_telegram_id(session, int(val))
        else:
            res = await session.execute(select(User).where(User.username.ilike(val)))
            target_user = res.scalar_one_or_none()
            
        if not target_user:
             await message.answer(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '{val}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ. –ü—É—Å—Ç—å –Ω–∞–∂–º–µ—Ç /start.")
             return

    # 2. –ü–†–ò–û–†–ò–¢–ï–¢: REPLY (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —Ñ–∞–Ω—Ç–æ–º–Ω—ã–π –æ—Ç–≤–µ—Ç —Ç–µ–º—ã)
    elif message.reply_to_message:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ "–æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å—Ç–∞—Ä—Ç —Ç–æ–ø–∏–∫–∞"
        is_phantom_reply = False
        if message.is_topic_message and message.message_thread_id:
            if message.reply_to_message.message_id == message.message_thread_id:
                is_phantom_reply = True
        
        if not is_phantom_reply:
            target_user = await UserCRUD.get_or_create(
                session,
                telegram_id=message.reply_to_message.from_user.id,
                username=message.reply_to_message.from_user.username or "",
                full_name=message.reply_to_message.from_user.full_name
            )
        else:
            # –ï—Å–ª–∏ —ç—Ç–æ —Ñ–∞–Ω—Ç–æ–º–Ω—ã–π —Ä–µ–ø–ª–∞–π –∏ –Ω–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ -> –û—à–∏–±–∫–∞
            await message.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username.")
            return
    
    # 3. –ù–ï–¢ –î–ê–ù–ù–´–•
    else:
        await message.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username.")
        return

    if not target_user or not target_user.telegram_id:
        # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
        await message.answer("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return

    in_channel = await UserChannelCRUD.in_user_in_channel(session, target_user.id, channel.id)
    if in_channel:
        await message.answer(f"{target_user.full_name} (ID: {target_user.telegram_id}) —É–∂–µ –≤ –∫–∞–Ω–∞–ª–µ.")
    else:
        await UserChannelCRUD.add_user_to_channel(session, target_user.id, channel.id)
        await message.answer(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω: {target_user.full_name}")


@router.message(Command("add_users"))
async def cmd_add_users(message: Message, command: CommandObject, session: AsyncSession):
    if not is_admin(message.from_user.id): return

    thread_id = message.message_thread_id if message.is_topic_message else None
    channel = await ChannelCRUD.get_by_chat_and_thread(session, message.chat.id, thread_id)
    if not channel:
        await message.answer("–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /add_ch")
        return

    if not command.args:
        await message.answer("–§–æ—Ä–º–∞—Ç: `/add_users @user1 @user2 @user3`")
        return

    # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥: –ø—Ä–æ–±–µ–ª—ã, –∑–∞–ø—è—Ç—ã–µ –∏ —Ç–æ—á–∫–∏ —Å –∑–∞–ø—è—Ç–æ–π
    processed_args = command.args.replace(",", " ").replace(";", " ")
    entries = [e.replace("@", "").strip() for e in processed_args.split() if e.strip()]

    added_names = []
    already_in_count = 0
    not_found = []

    for entry in entries:
        u = None
        if entry.isdigit():
            u = await UserCRUD.get_by_telegram_id(session, int(entry))
        else:
            # –ü–æ–∏—Å–∫ –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É –≤ –±–∞–∑–µ
            res = await session.execute(select(User).where(User.username.ilike(entry)))
            u = res.scalar_one_or_none()

        if u:
            if not await UserChannelCRUD.in_user_in_channel(session, u.id, channel.id):
                await UserChannelCRUD.add_user_to_channel(session, u.id, channel.id)
                name = f"@{u.username}" if u.username else u.full_name
                added_names.append(name)
            else:
                already_in_count += 1
        else:
            not_found.append(entry)

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    response = []
    if added_names:
        response.append(f"<b>–î–æ–±–∞–≤–ª–µ–Ω—ã:</b>\n" + ", ".join(added_names))
    else:
        response.append("–ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.")

    if already_in_count:
        response.append(f"‚Ñπ–ü—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ –≤ —Å–ø–∏—Å–∫–µ): {already_in_count}")

    if not_found:
        response.append(f"<b>–ù–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ:</b>\n" + ", ".join(not_found))

    await message.answer("\n\n".join(response))

@router.message(Command("rm_user"))
async def cmd_rm_user(message: Message, command: CommandObject, session: AsyncSession):
    if not is_admin(message.from_user.id): return
    
    thread_id = message.message_thread_id if message.is_topic_message else None
    channel = await ChannelCRUD.get_by_chat_and_thread(session, message.chat.id, thread_id)
    if not channel: 
        await message.answer("–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    target_user = None
    args = command.args

    # 1. –ê–†–ì–£–ú–ï–ù–¢–´
    if args:
        val = args.replace("@", "").strip()
        if not val:
            await message.answer("‚ö†–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username.")
            return

        if val.isdigit():
            target_user = await UserCRUD.get_by_telegram_id(session, int(val))
        else:
            res = await session.execute(select(User).where(User.username.ilike(val)))
            target_user = res.scalar_one_or_none()
            
    # 2. REPLY
    elif message.reply_to_message:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ñ–∞–Ω—Ç–æ–º–Ω—ã–π —Ä–µ–ø–ª–∞–π
        is_phantom_reply = False
        if message.is_topic_message and message.message_thread_id:
            if message.reply_to_message.message_id == message.message_thread_id:
                is_phantom_reply = True
        
        if not is_phantom_reply:
            target_user = await UserCRUD.get_by_telegram_id(session, message.reply_to_message.from_user.id)
        else:
            await message.answer("‚ö†–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username.")
            return
    
    else:
        await message.answer("‚ö†–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username.")
        return

    if target_user:
        removed = await UserChannelCRUD.remove_user_from_channel(session, target_user.id, channel.id)
        if removed:
            await message.answer(f"–£–¥–∞–ª–µ–Ω: {target_user.full_name}")
        else:
            await message.answer(f"‚ö†–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_user.full_name} –Ω–µ –±—ã–ª –≤ —ç—Ç–æ–º –∫–∞–Ω–∞–ª–µ.")
    else:
        await message.answer("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.")


@router.message(Command("rm_users"))
async def cmd_rm_users(message: Message, command: CommandObject, session: AsyncSession):
    if not is_admin(message.from_user.id): return

    thread_id = message.message_thread_id if message.is_topic_message else None
    channel = await ChannelCRUD.get_by_chat_and_thread(session, message.chat.id, thread_id)

    if not channel:
        await message.answer("–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    if not command.args:
        await message.answer("–§–æ—Ä–º–∞—Ç: `/rm_users @user1 @user2`")
        return

    processed_args = command.args.replace(",", " ").replace(";", " ")
    entries = [e.replace("@", "").strip() for e in processed_args.split() if e.strip()]

    removed_names = []
    not_found = []

    for entry in entries:
        u = None
        if entry.isdigit():
            u = await UserCRUD.get_by_telegram_id(session, int(entry))
        else:
            res = await session.execute(select(User).where(User.username.ilike(entry)))
            u = res.scalar_one_or_none()

        if u:
            if await UserChannelCRUD.remove_user_from_channel(session, u.id, channel.id):
                name = f"@{u.username}" if u.username else u.full_name
                removed_names.append(name)
            else:
                not_found.append(f"@{u.username}" if u.username else u.full_name)
        else:
            not_found.append(entry)

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    response = []
    if removed_names:
        response.append(f"<b>–£–¥–∞–ª–µ–Ω—ã –∏–∑ –∫–∞–Ω–∞–ª–∞:</b>\n" + ", ".join(removed_names))
    else:
        response.append("–ù–∏–∫—Ç–æ –Ω–µ –±—ã–ª —É–¥–∞–ª–µ–Ω.")

    if not_found:
        response.append(f"<b>–ù–µ –Ω–∞–π–¥–µ–Ω—ã (–∏–ª–∏ –Ω–µ –±—ã–ª–∏ –≤ –∫–∞–Ω–∞–ª–µ):</b>\n" + ", ".join(not_found))

    await message.answer("\n\n".join(response))

# --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ö–∞–Ω–∞–ª–∞–º–∏ –∏ –°–æ–±—ã—Ç–∏—è–º–∏ ---

@router.message(Command("add_ch"))
async def cmd_add_channel(message: Message, command: CommandObject, session: AsyncSession):
    if not is_admin(message.from_user.id): return
    if message.chat.type == "private": return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ (–∏—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4)
    args = command.args.split() if command.args else []
    if len(args) < 4:
        await message.answer(
            "<b>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é:</b>\n"
            "<code>add_ch [–Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ—Ä—Ç–∞] [–∫–ª—é—á (–∏–ª–∏ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ)] [–≤—Ä–µ–º—è (–¥–µ–¥–ª–∞–π–Ω)] [–∫–æ–ª–≤–æ —Ñ–æ—Ç–æ]</code>\n\n"
            "<b>–ü—Ä–∏–º–µ—Ä:</b>\n"
            "<code>/add_ch –£–±–æ—Ä–∫–∞ —á–∏—Å—Ç–æ 21:00 2</code>"
        )
        return

    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    title = args[0]
    keyword = args[1]
    time_str = args[2]
    try:
        min_photos = int(args[3])
        h, m = map(int, time_str.split(':'))
        deadline = time(h, m)
    except Exception:
        await message.answer("–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞! –í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ß–ß:–ú–ú, –∞ —Ñ–æ—Ç–æ ‚Äî —á–∏—Å–ª–æ–º.")
        return

    thread_id = message.message_thread_id if message.is_topic_message else None

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
    existing = await ChannelCRUD.get_by_chat_and_thread(session, message.chat.id, thread_id)
    if existing:
        await message.answer(
            f"<b>–û—à–∏–±–∫–∞:</b> –≤ –¥–∞–Ω–Ω–æ–º —á–∞—Ç–µ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –∫–∞–Ω–∞–ª '{existing.title}' "
            "–∏ –≤—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Ç—É—Ç —á—Ç–æ-–ª–∏–±–æ –¥–æ–±–∞–≤–∏—Ç—å."
        )
        return

    # –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ —Å –ø–æ–ª–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π
    await ChannelCRUD.create(
        session,
        telegram_id=message.chat.id,
        thread_id=thread_id,
        title=title,
        report_type=title,  # –¢–∏–ø —Ä–µ–ø–æ—Ä—Ç–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∏–º–µ–Ω–µ–º –∫–∞–Ω–∞–ª–∞
        keyword=keyword,
        deadline_time=deadline,
        min_photos=min_photos
    )
    await message.answer(f"–ö–∞–Ω–∞–ª <b>'{title}'</b> —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!")

@router.message(Command("rm_ch"))
async def cmd_rm_channel(message: Message, command: CommandObject, session: AsyncSession):
    if not is_admin(message.from_user.id): return

    if not command.args:
        await message.answer("<b>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</b>\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: <code>/rm_ch [–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞]</code>")
        return

    # –û—á–∏—â–∞–µ–º –≤–≤–æ–¥ –æ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –ø–æ –∫—Ä–∞—è–º
    target_title = command.args.strip()
    thread_id = message.message_thread_id if message.is_topic_message else None

    channel = await ChannelCRUD.get_by_chat_and_thread(session, message.chat.id, thread_id)

    if not channel:
        await message.answer("–í —ç—Ç–æ–º —á–∞—Ç–µ/–≤–µ—Ç–∫–µ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤.")
        return

    # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –∏ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
    if channel.title.strip().lower() != target_title.lower():
        await message.answer(
            f"–ù–∞–∑–≤–∞–Ω–∏–µ '<code>{target_title}</code>' –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç.\n"
            f"–¢–µ–∫—É—â–∏–π –∫–∞–Ω–∞–ª –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è: '<code>{channel.title}</code>'\n"
            f"<i>(–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏–∫–æ–º)</i>"
        )
        return

    success = await ChannelCRUD.delete_channel(session, channel.id)
    if success:
        await message.answer(f"–ö–∞–Ω–∞–ª <b>'{channel.title}'</b> —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π.")

@router.message(Command("add_event"))
async def cmd_add_event(message: Message, command: CommandObject, session: AsyncSession):
    if not is_admin(message.from_user.id): return

    # 1. –ï—Å–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç ‚Äî –≤—ã–≤–æ–¥–∏–º –ø–æ–º–æ—â—å
    if not command.args:
        await message.answer(
            "<b>–ü–æ–º–æ—â–Ω–∏–∫ –ø–æ –∫–æ–º–∞–Ω–¥–µ /add_event:</b>\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç:\n"
            "<code>/add_event [—Ç–∏–ø] [–∫–ª—é—á], [–¥–∞—Ç–∞] [–≤—Ä–µ–º—è] [–º–∏–Ω_—Ñ–æ—Ç–æ]</code>\n\n"
            "<b>–ü—Ä–∏–º–µ—Ä:</b>\n"
            "<code>/add_event –£–±–æ—Ä–∫–∞ —á–∏—Å—Ç–æ, 14.07 23:10 2</code>\n\n"
            "<i>–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ, —á—Ç–æ–±—ã –æ–Ω–æ —Å—Ç–∞–ª–æ —à–∞–±–ª–æ–Ω–æ–º.</i>"
        )
        return

    # 2. –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–∏ (–¥–µ–ª–∏–º –ø–æ –∑–∞–ø—è—Ç–æ–π)
    try:
        if "," not in command.args:
            raise ValueError("Missing comma")

        head, tail = command.args.split(",", 1)
        head_parts = head.split()  # —Ç–∏–ø, –∫–ª—é—á–µ–≤–æ–µ_—Å–ª–æ–≤–æ
        tail_parts = tail.split()  # –¥–∞—Ç–∞, –≤—Ä–µ–º—è, –º–∏–Ω_—Ñ–æ—Ç–æ

        if len(head_parts) < 2:
            await message.answer("–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø –∏ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –ø–µ—Ä–µ–¥ –∑–∞–ø—è—Ç–æ–π.")
            return

        r_type = head_parts[0].strip()
        keyword = head_parts[1].strip()

        if len(tail_parts) < 2:
            await message.answer("–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä: 14.07 23:10).")
            return

        date_str = tail_parts[0]  # –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–∞—Ä—Å–∏–º, –Ω–æ –≤ –ë–î –ø–∏—à–µ–º –≤—Ä–µ–º—è
        time_str = tail_parts[1]

        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ
        if len(tail_parts) < 3:
            await message.answer("–í—ã –∑–∞–±—ã–ª–∏ —É–∫–∞–∑–∞—Ç—å –º–∏–Ω. –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∫–æ–ª-–≤–æ —Ñ–æ—Ç–æ.")
            return

        min_photos = int(tail_parts[2])

        # –ü–∞—Ä—Å–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ –ß–ß:–ú–ú
        h, m = map(int, time_str.split(':'))
        deadline = time(h, m)

    except ValueError:
        await message.answer("–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞! –ü—Ä–∏–º–µ—Ä: <code>–£–±–æ—Ä–∫–∞ —á–∏—Å—Ç–æ, 14.07 23:10 2</code>")
        return
    except Exception as e:
        await message.answer(f" –û—à–∏–±–∫–∞: {str(e)}")
        return

    # 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –≤ –±–∞–∑–µ
    thread_id = message.message_thread_id if message.is_topic_message else None
    channel = await ChannelCRUD.get_by_chat_and_thread(session, message.chat.id, thread_id)

    if not channel:
        await message.answer("–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /add_ch")
        return

    await ChannelCRUD.update_event(session, channel.id, r_type, keyword, deadline, min_photos)

    # 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ (–µ—Å–ª–∏ –æ–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ)
    photo_msg = ""
    if message.photo:
        # –ë–µ—Ä–µ–º —Ñ–æ—Ç–æ –≤ —Å–∞–º–æ–º –≤—ã—Å–æ–∫–æ–º –∫–∞—á–µ—Å—Ç–≤–µ
        file_id = message.photo[-1].file_id
        file = await message.bot.get_file(file_id)
        photo_bytes = await message.bot.download_file(file.file_path)

        await PhotoTemplateCRUD.add_template(
            session,
            channel.id,
            file_id,
            photo_bytes.read(),
            f"–®–∞–±–ª–æ–Ω –¥–ª—è {r_type}"
        )
        photo_msg = "\n–§–æ—Ç–æ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫ —à–∞–±–ª–æ–Ω."

    await message.answer(f"–°–æ–±—ã—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!{photo_msg}")


@router.message(Command("rm_event"))
async def cmd_rm_event(message: Message, session: AsyncSession):
    """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–Ω–∞–ª–∞"""
    if not is_admin(message.from_user.id): return

    thread_id = message.message_thread_id if message.is_topic_message else None
    channel = await ChannelCRUD.get_by_chat_and_thread(session, message.chat.id, thread_id)

    if not channel:
        await message.answer("–í —ç—Ç–æ–º —á–∞—Ç–µ/–≤–µ—Ç–∫–µ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞.")
        return

    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ–±—ã—Ç–∏—è –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    await ChannelCRUD.update_event(
        session,
        channel.id,
        report_type="–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ",
        keyword="",
        deadline_time=time(0, 0),
        min_photos=1
    )
    await message.answer(f"–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–∞–Ω–∞–ª–∞ <b>'{channel.title}'</b> —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω—ã.")

@router.message(Command("list_channels"))
async def cmd_list_channels(message: Message, session: AsyncSession):
    if not is_admin(message.from_user.id): return

    channels = await ChannelCRUD.get_all_active(session)  #
    if not channels:
        await message.answer("–°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –ø—É—Å—Ç.")
        return

    text = "<b>–°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤:</b>\n\n"
    for ch in channels:
        thread_info = f" (–í–µ—Ç–∫–∞ ID: {ch.thread_id})" if ch.thread_id else " (–û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç)"
        text += f"‚Ä¢ <b>{ch.title}</b>{thread_info}\n"
        text += f"  ‚îî –ö–ª—é—á: <code>{ch.keyword or '–Ω–µ –∑–∞–¥–∞–Ω'}</code> | –¢–∏–ø: {ch.report_type}\n"

    await message.answer(text)


@router.message(Command("list_users"))
async def cmd_list_users(message: Message, session: AsyncSession):
    """–í—ã–≤–æ–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫ —Ç–µ–∫—É—â–µ–º—É –∫–∞–Ω–∞–ª—É/–≤–µ—Ç–∫–µ"""
    if not is_admin(message.from_user.id): return

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç (—á–∞—Ç –∏ –≤–µ—Ç–∫–∞)
    thread_id = message.message_thread_id if message.is_topic_message else None
    channel = await ChannelCRUD.get_by_chat_and_thread(session, message.chat.id, thread_id)

    if not channel:
        await message.answer("–≠—Ç–æ—Ç —á–∞—Ç –∏–ª–∏ –≤–µ—Ç–∫–∞ –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∫–∞–∫ –∫–∞–Ω–∞–ª. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>/add_ch</code>")
        return

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ë–î —á–µ—Ä–µ–∑ UserChannelCRUD
    users = await UserChannelCRUD.get_users_by_channel(session, channel.id)

    if not users:
        await message.answer(f"–í –∫–∞–Ω–∞–ª–µ <b>{channel.title}</b> –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
        return

    text = f"<b>–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ({channel.title}):</b>\n\n"
    for i, user in enumerate(users, 1):
        username = f"@{user.username}" if user.username else "<i>(–±–µ–∑ username)</i>"
        text += f"{i}. {user.full_name} ‚Äî {username} (ID: <code>{user.telegram_id}</code>)\n"

    await message.answer(text)

@router.message(Command("get_user_id"))
async def cmd_get_user_id(message: Message, command: CommandObject, session: AsyncSession):
    """
    –£–∑–Ω–∞—Ç—å ID.
    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
    1. –ê—Ä–≥—É–º–µ–Ω—Ç (command.args)
    2. Reply (—Ä–µ–∞–ª—å–Ω—ã–π, –∞ –Ω–µ —Ñ–∞–Ω—Ç–æ–º–Ω—ã–π –æ—Ç–≤–µ—Ç —Ç–µ–º—ã)
    3. –°–≤–æ–π ID
    """
    
    # 1. –ü–†–ò–û–†–ò–¢–ï–¢: –ê–†–ì–£–ú–ï–ù–¢–´
    if command.args:
        val = command.args.replace("@", "").strip()
        
        if not val:
            await message.answer("–í—ã –≤–≤–µ–ª–∏ –ø—É—Å—Ç–æ–π username.")
            return

        u_db = None
        if val.isdigit():
            u_db = await UserCRUD.get_by_telegram_id(session, int(val))
        else:
            res = await session.execute(select(User).where(User.username.ilike(val)))
            u_db = res.scalar_one_or_none()
        
        if u_db:
            await message.answer(
                f"üóÉ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∏–∑ –±–∞–∑—ã):</b>\n"
                f"ID: <code>{u_db.telegram_id}</code>\n"
                f"–ò–º—è: {u_db.full_name}\n"
                f"Username: @{u_db.username}"
            )
        else:
            await message.answer(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '{val}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞.\n–ü—É—Å—Ç—å –Ω–∞–∂–º–µ—Ç /start.")
        return

    # 2. –ü–†–ò–û–†–ò–¢–ï–¢: REPLY (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —Ñ–∞–Ω—Ç–æ–º–Ω—ã–π –æ—Ç–≤–µ—Ç —Ç–µ–º—ã)
    reply_valid = False
    
    if message.reply_to_message:
        reply_valid = True
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ "–æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å—Ç–∞—Ä—Ç —Ç–æ–ø–∏–∫–∞" (–æ–±—ã—á–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤ —Ñ–æ—Ä—É–º–∞—Ö)
        if message.is_topic_message and message.message_thread_id:
            if message.reply_to_message.message_id == message.message_thread_id:
                reply_valid = False  # –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Ç–µ–º–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–∞–∫ —Ä–µ–ø–ª–∞–π
    
    if reply_valid:
        u_reply = message.reply_to_message.from_user
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É (–∫–∞–∫ –≤ add_user)
        user = await UserCRUD.get_or_create(
            session,
            telegram_id=u_reply.id,
            username=u_reply.username or "",
            full_name=u_reply.full_name
        )
        
        await message.answer(
            f"<b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (Reply):</b>\n"
            f"ID: <code>{user.telegram_id}</code>\n"
            f"–ò–º—è: {user.full_name}\n"
            f"Username: @{user.username}\n"
            f"<i>(–°–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑–µ)</i>"
        )
        return

    # 3. –ü–†–ò–û–†–ò–¢–ï–¢: –°–í–û–ô ID (–ï—Å–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç –∏ —Ä–µ–ø–ª–∞–π –±—ã–ª —Ñ–∞–Ω—Ç–æ–º–Ω—ã–º –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª)
    u = message.from_user
    await message.answer(
        f"<b>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:</b>\n"
        f"ID: <code>{u.id}</code>\n"
        f"–ò–º—è: {u.full_name}\n"
        f"Username: @{u.username}"
    )


# --- –®–∞–±–ª–æ–Ω—ã ---

@router.message(Command("add_template"))
async def cmd_add_template(message: Message, state: FSMContext):
    if not is_admin(message.from_user.id): return
    
    thread_id = message.message_thread_id if message.is_topic_message else None
    template_data[message.from_user.id] = {
        'chat_id': message.chat.id, 'thread_id': thread_id, 'photos': []
    }
    await state.set_state(PhotoTemplateStates.waiting_for_photos)
    await message.answer("–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ. –í –∫–æ–Ω—Ü–µ –Ω–∞–ø–∏—à–∏—Ç–µ /done")

@router.message(PhotoTemplateStates.waiting_for_photos, F.photo)
async def receive_template_photos(message: Message):
    data = template_data.get(message.from_user.id)
    if data:
        data['photos'].append(message.photo[-1].file_id)
        await message.answer(f"–§–æ—Ç–æ {len(data['photos'])} –ø—Ä–∏–Ω—è—Ç–æ.")

@router.message(PhotoTemplateStates.waiting_for_photos, Command("done"))
async def template_photos_done(message: Message, state: FSMContext):
    data = template_data.get(message.from_user.id)
    if not data or not data['photos']:
        await message.answer("–ù–µ—Ç —Ñ–æ—Ç–æ.")
        return
    await state.set_state(PhotoTemplateStates.waiting_for_description)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ (–∏–ª–∏ /skip)")

@router.message(PhotoTemplateStates.waiting_for_description)
async def receive_template_desc(message: Message, state: FSMContext, session: AsyncSession):
    data = template_data.get(message.from_user.id)
    desc = None if message.text == "/skip" else message.text
    
    if data:
        channel = await ChannelCRUD.get_by_chat_and_thread(session, data['chat_id'], data['thread_id'])
        if channel:
            for fid in data['photos']:
                f = await message.bot.get_file(fid)
                b = await message.bot.download_file(f.file_path)
                await PhotoTemplateCRUD.add_template(session, channel.id, fid, b.read(), desc)
            await message.answer("–®–∞–±–ª–æ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.")
    
    del template_data[message.from_user.id]
    await state.clear()