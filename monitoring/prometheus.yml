# prometheus configuration

global:
  # интервал для сбора метрик
  scrape_interval: 15s
  # интервал оценки правил
  evaluation_interval: 15s
  # таймаут для сбора метрик
  scrape_timeout: 10s

  # external labels для идентификации
  external_labels:
    cluster: 'report-bot'
    environment: 'production'
    region: 'local'

# alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 'alertmanager:9093'
      # таймаут для отправки алертов
      timeout: 10s
      # параметры для api
      api_version: v2

# load rules
rule_files:
  - 'alerts.yml'
  - 'recording_rules.yml'

# scrape configurations
scrape_configs:
  # --- prometheus self ---
  - job_name: 'prometheus'
    static_configs:
      - targets: ['bot:8000']
    metrics_path: '/metrics'
    scrape_interval: 10s

    # relabeling для добавления меток
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'report-bot'

    # metric relabeling
    metric_relabel_configs:
      # удаляем ненужные метрики
      - source_labels: [__name__]
        regex: 'go_.*'
        action: drop
      - source_labels: [__name__]
        regex: 'process.*'
        action: drop

  # --- postgresql exporter ---
  # раскомментируйте, если используете postgresql
#  - job_name: 'postgres'
#    static_configs:
#      - targets: ['postgres-exporter:9187']
#    scrape_interval: 30s

  # --- node exporter (system metrics) ---
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']
    scrape_interval: 15s

    # relabeling
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'localhost'

  # --- cadvisor (container metrics) ---
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
    scrape_interval: 30s

    # metric relabeling для уменьшения нагрузки
    metric_relabel_configs:
      # оставляем только важные метрики
      - source_labels: [__name__]
        regex: 'container_(cpu|memory|network|fs).*'
        action: keep

  # --- redis exporter ---
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
    scrape_interval: 30s

  # --- loki ---
  - job_name: 'loki'
    static_configs:
      - targets: ['loki:3100']
    metrics_path: '/metrics'
    scrape_interval: 30s

  # --- grafana ---
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
    metrics_path: '/metrics'
    scrape_interval: 30s

  # --- alertmanager ---
  - job_name: 'alertmanager'
    static_configs:
      - targets: ['alertmanager:9093']
    metrics_path: '/metrics'
    scrape_interval: 30s

  # --- docker containers (auto-discovery) ---
  # авто обнаружение контейнеров с метками
  - job_name: 'docker'
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 30s

    # только контейнеры с меткой prometheus.scrape=true
    relabel_configs:
      - source_labels: [__meta_docker_container_label_prometheus_scrape]
        regex: 'true'
        action: keep

      # получить порт из метки
      - source_labels: [__meta_docker_container_label_prometheus_port]
        target_label: __address__
        regex: '(.+)'
        replacement: '${1}:${__meta_docker_container_prometheus_port}'

      # имя контейнера
      - source_labels: [__meta_docker_container_name]
        target_label: container_name
        regex: '/(.+)'
        replacement: '${1}'

      # id контейнера
      - source_labels: [__meta_docker_container_id]
        target_label: container_id
        regex: '(.{12}).*'
        replacement: '${1}'

# storage configuration
storage:
  tsdb:
    # retention
    retention.time: 30d
    retention.size: 10GB

    # compression
    wal_compression: true

    # chunk range
    min_block_duration: 2h
    max_block_duration: 2h

# remote write (опционально для long-term storage)
remote_write:
  - url: "http://victoriametrics:8428/api/v1/write"
    queue_config:
      max_samples_per_send: 10000
      max_shards: 30